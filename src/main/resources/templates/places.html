<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby Places</title>
    <!-- 카카오 지도 API를 불러오는 스크립트 -->
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=00d1961c0cca06b3691129126dbc752c"></script>
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
        #place-info {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
<h1>Nearby Places</h1>
<div id="map"></div>
<div id="place-info">
    <p>위도: <span id="latitude"></span></p>
    <p>경도: <span id="longitude"></span></p>
    <table>
        <thead>
        <tr>
            <th>이름</th>
            <th>위도</th>
            <th>경도</th>
        </tr>
        </thead>
        <tbody id="places-list">
        <!-- 장소 데이터가 여기에 표시됩니다 -->
        </tbody>
    </table>
</div>

<script th:inline="javascript">
    // Thymeleaf를 사용하여 서버에서 전달받은 places 데이터를 JavaScript 변수로 설정
    var places = /*[[${places}]]*/ [];

    // 페이지가 로드된 후 지도 초기화 함수
    function initMap() {
        // URL 파라미터에서 위도, 경도, 범위를 가져옵니다
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get('lat'));
        const lon = parseFloat(urlParams.get('lon'));
        const range = parseFloat(urlParams.get('range'));

        if (lat && lon && range) {
            // 지도 생성 및 표시
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(lat, lon),
                level: 7 // 지도의 확대 레벨
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            console.log('Places Data:', places); // 데이터 확인용 로그

            // 장소 데이터가 비어있는지 확인
            if (Array.isArray(places) && places.length > 0) {
                // 장소를 테이블에 추가
                const placesList = document.getElementById('places-list');
                places.forEach(place => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${place.name}</td>
                        <td>${place.latitude}</td>
                        <td>${place.longitude}</td>
                    `;
                    placesList.appendChild(row);

                    // 마커 추가
                    const markerPosition = new kakao.maps.LatLng(place.latitude, place.longitude);
                    const marker = new kakao.maps.Marker({
                        position: markerPosition,
                        map: map
                    });

                    // 장소에 대한 정보창 설정
                    const infoWindow = new kakao.maps.InfoWindow({
                        content: `<div style="padding:5px;">${place.name}</div>`
                    });

                    kakao.maps.event.addListener(marker, 'click', function() {
                        infoWindow.open(map, marker);
                    });
                });
            } else {
                console.log('주변 장소 데이터가 없습니다.');
            }

            // 위도와 경도를 표시합니다
            document.getElementById('latitude').textContent = lat;
            document.getElementById('longitude').textContent = lon;
        } else {
            alert('위도, 경도 또는 범위 파라미터가 올바르지 않습니다.');
        }
    }

    // 카카오 지도 API 로딩 후 지도 초기화
    kakao.maps.load(initMap);
</script>
</body>
</html>